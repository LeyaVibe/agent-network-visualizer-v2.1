# Руководство по рефакторингу и тестированию

**Автор**: Manus AI
**Дата**: 21 октября 2025

## 1. Введение

Это руководство описывает проведенный рефакторинг и внедрение автоматизированной системы тестирования для проекта **Agent Network Visualizer v2.1**. Целью было повышение поддерживаемости кода, улучшение его организации и создание надежной среды для будущих разработок и модификаций.

Внедрение автоматизированных тестов позволяет быстро проверять функциональность, выявлять регрессии и гарантировать, что изменения в одной части приложения не нарушают работу другой. Это устраняет необходимость в постоянном ручном тестировании через пользовательский интерфейс.

---

## 2. Новая структура кода и рефакторинг

Для улучшения модульности и разделения ответственности были созданы два новых ключевых модуля в директории `src/lib/`.

### `simulationConfig.js`

Этот модуль централизует всю конфигурацию, связанную с симуляцией. Он отвечает за управление параметрами, их валидацию и применение.

**Ключевые экспорты:**

| Функция/Константа     | Описание                                                                                             |
| --------------------- | ---------------------------------------------------------------------------------------------------- |
| `DEFAULT_PARAMS`        | Объект с параметрами симуляции по умолчанию.                                                         |
| `PARAM_CONSTRAINTS`     | Определяет минимальные/максимальные значения и шаг для каждого параметра.                            |
| `SCENARIOS`             | Определения базовых сценариев симуляции.                                                            |
| `PRESET_SCENARIOS`      | Определения расширенных сценариев для `EnhancedScenarioManager`.                                    |
| `validateParams(params)` | Проверяет, соответствуют ли параметры заданным ограничениям.                                         |
| `createConfig(params)`  | Создает полный и проверенный объект конфигурации, объединяя параметры с настройками по умолчанию.      |

### `simulationState.js`

Этот модуль управляет состоянием симуляции, предоставляя чистые функции для его изменения. Это помогает избежать прямого манипулирования состоянием в компонентах.

**Ключевые экспорты:**

| Функция                     | Описание                                                                        |
| --------------------------- | ------------------------------------------------------------------------------- |
| `createInitialState()`        | Возвращает начальное состояние симуляции.                                       |
| `setRunning(state, isRunning)` | Устанавливает флаг выполнения симуляции.                                        |
| `setError(state, error)`      | Устанавливает сообщение об ошибке и останавливает симуляцию.                     |
| `setResults(state, results)`  | Сохраняет результаты симуляции и завершает ее.                                  |
| `isReadyToRun(state, params)` | Проверяет, готова ли симуляция к запуску.                                       |
| `getSimulationSummary(state)` | Возвращает сводку по результатам для отображения в интерфейсе.                    |

---

## 3. Автоматизированное тестирование

Для обеспечения надежности кода была внедрена комплексная система тестирования на базе **Vitest** и **React Testing Library**.

### Стек тестирования

- **Vitest**: Современный и быстрый фреймворк для тестирования, совместимый с Vite.
- **React Testing Library**: Библиотека для тестирования React-компонентов, ориентированная на взаимодействие с пользователем.
- **jsdom**: Реализация веб-стандартов в Node.js для запуска тестов без браузера.

### Типы тестов

Тесты разделены на три категории и находятся в директории `src/test/`:

1.  **Unit-тесты (`agentSimulation.test.js`)**: Проверяют отдельные функции из `agentSimulation.js`, такие как `cosineSimilarity`, `generateAgentPopulation` и другие. Это гарантирует, что базовые алгоритмы работают корректно.

2.  **Интеграционные тесты (`simulation.integration.test.js`)**: Проверяют полный жизненный цикл симуляции, от генерации агентов до создания отчета. Это гарантирует, что все модули правильно взаимодействуют друг с другом.

3.  **Тесты сценариев (`scenarios.test.js`)**: Проверяют работу симуляции с различными параметрами и сценариями, включая динамический пересчет кластеров и работу с большим количеством агентов.

### Вспомогательные утилиты для тестов (`testHelpers.js`)

Для упрощения написания тестов был создан файл `src/test/testHelpers.js`, который содержит вспомогательные функции:

- `createTestSimulation()`: Создает полную симуляцию с заданными параметрами.
- `compareSimulations()`: Сравнивает результаты двух симуляций.
- `calculateClusterStats()`: Рассчитывает статистику по кластерам.

---

## 4. Как запускать тесты

Для удобного запуска тестов были добавлены новые скрипты в `package.json` и создан исполняемый файл `run-tests.sh`.

### Использование `pnpm`

| Команда                 | Описание                                                          |
| ----------------------- | ----------------------------------------------------------------- |
| `pnpm test`             | Запускает тесты в интерактивном режиме (watch mode).              |
| `pnpm test:run`         | Запускает все тесты один раз и выводит результат в консоль.       |
| `pnpm test:coverage`    | Запускает тесты и генерирует отчет о покрытии кода.               |
| `pnpm test:ui`          | Запускает тесты с графическим интерфейсом Vitest UI.              |

### Использование скрипта `run-tests.sh`

Для еще большего удобства используйте скрипт `./run-tests.sh`:

```bash
# Запустить все тесты
./run-tests.sh

# Запустить только unit-тесты
./run-tests.sh unit

# Запустить только интеграционные тесты
./run-tests.sh integration

# Запустить тесты сценариев
./run-tests.sh scenarios

# Запустить тесты и сгенерировать отчет о покрытии
./run-tests.sh coverage

# Быстрый запуск с минимальным выводом
./run-tests.sh quick
```

## 5. Как добавлять новые тесты

1.  Создайте новый файл с суффиксом `.test.js` в директории `src/test/`.
2.  Импортируйте необходимые функции и утилиты.
3.  Используйте `describe`, `it` и `expect` из Vitest для написания тест-кейсов.

**Пример простого теста:**

```javascript
import { describe, it, expect } from 'vitest';
import { cosineSimilarity } from '../lib/agentSimulation';

describe('Cosine Similarity', () => {
  it('should return 1 for identical vectors', () => {
    const vec1 = [1, 1, 1];
    const vec2 = [1, 1, 1];
    expect(cosineSimilarity(vec1, vec2)).toBeCloseTo(1);
  });
});
```

---

## 6. Заключение

Проведенный рефакторинг и внедрение автоматизированных тестов значительно улучшили качество и надежность кодовой базы. Теперь проект готов к дальнейшему развитию с минимальными рисками и затратами на ручное тестирование.

**Ключевые преимущества:**

- **Надежность**: 55 автоматизированных тестов покрывают ключевую логику.
- **Поддерживаемость**: Код разделен на логические модули.
- **Скорость разработки**: Быстрый запуск тестов ускоряет проверку изменений.
- **Удобство**: Скрипт `run-tests.sh` упрощает запуск нужных тестов.

